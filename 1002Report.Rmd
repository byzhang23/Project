---
title: "Report 10/04"
author: "Boyang Zhang"
output: pdf_document
---

```{r echo=FALSE,message=FALSE,warning=FALSE}
library(dplyr)
library(foreign)
library(haven)
library(zoo)
library(maps)
library(ggmap)
library(ggplot2)
library(readr)
library(tidyr)
library(readxl)
library(stringr)
library(RColorBrewer)
library(devtools) 
#install_github("choroplethr", "trulia") 


source("http://peterhaschke.com/Code/multiplot.R")
source(file.path("R_code","1-function.R"))

data_path=paste0(getwd(),"/data/raw_data/")

#population:2011-2015 (MD and DC)
pop_md=change_pop("data/raw_data/population/population_MD_DC.csv")
pop_md=pop_md %>% select(geo_id,year,population)
```

```{r income,echo=FALSE,message=FALSE,warning=FALSE,results='hide'}
#median household income (2011-2014)
income11=read_income("data/raw_data/income/county/est11ALL.xls")
income12=read_income("data/raw_data/income/county/est12ALL.xls")
income13=read_income("data/raw_data/income/county/est13ALL.xls")
income14=read_income("data/raw_data/income/county/est14ALL.xls")

#extract MD_DC median household income(2011-2014)
inc_sub11=income_md_dc(income11)
inc_sub12=income_md_dc(income12)
inc_sub13=income_md_dc(income13)
inc_sub14=income_md_dc(income14)
inc_md=rbind(inc_sub11,inc_sub12,inc_sub13,inc_sub14) %>% select(geo_id,year,median_income)


#combine population+income(county)(2011-2014)
info_md=dplyr::inner_join(pop_md,inc_md)
```


####Introduction


The data used in this research is obtained from the Fatality Analysis Reporting System of the National Highway Traffic Safety Administration from years 2011 to 2015. Population estimates of each county from 2011 to 2015 is obtained from U.S. Census Bureau based on most recent decennial census data (http://www.census.gov/popest/data/counties/totals/2015/CO-EST2015-01.html). Median household income of each county from 2011 to 2014 is also obtained from U.S.Census Bureau (https://www.census.gov/did/www/saipe/data/statecounty/data/index.html). 



####Goal of this study

1. To identify communities that might be at a higher risk for fatal crashes, either in county-level or state-level
2. Since Maryland continues to be ranked as the richest state in the U.S., we want to analyze relationship between economic conditions (i.e. median household income) and fatality rate in MD and District of Columbia area. Also, we could broaden our analysis to other states in U.S.


```{r 2011-2015 accident files,echo=FALSE}
####2011-2015 trend accident
#merge data from 2011-2015
acc1=filter_dat(file.path(paste0(data_path,"2011"),"accident.sas7bdat"))
acc2=filter_dat(file.path(paste0(data_path,"2012"),"accident.sas7bdat"))
acc3=filter_dat(file.path(paste0(data_path,"2013"),"accident.sas7bdat"))
acc4=filter_dat(file.path(paste0(data_path,"2014"),"accident.sas7bdat"))
acc5=filter_dat(file.path(paste0(data_path,"2015"),"accident.sas7bdat"))

acc_tmp=subset(rbind(acc1,acc2,acc3,acc4),select = -`road_fnc`)
acc5=subset(acc5,select = -c(`func_sys`,`rd_owner`,`rur_urb`))
acc=rbind(acc_tmp,acc5)

acc$typ_int=ifelse(acc$typ_int==98 |acc$typ_int==99,NA,acc$typ_int)
```


####Accident file(2011-2015):


Among `r dim(acc)[1]` accidents and `r sum(acc$fatals)` fatalities, several crash-level related factors are listed as follows. Here, we merged data based on common columns shared by accident data files from 2011 to 2015.
    
__1. Time-varying variables__

* Seasonality (month): there is no extreme difference across months
* Day of week: on Mondays and Sundays, accidents are more likely to happen in MD and DC area.

__2. Geographical factors__

* Intersection type: most of the accidents do not occur in intersection area and remaining accidents are mostly occurred in four-way intersection and T intersection.
* National highway system: among all accidents, a quarter of accidents are in NHS.
* Trafficway: identify specific roads

__3. Enviornmental factors__

* Light condition: indicate type/level of light that existed at the time of the crash( day or night). 
* Weather: summary of weather condition. Most of the accidents do not occur during adverse weather conditions.
	
__4. Information about crash__

* Number of persons not in vehicles in transport: most of the accidents do not involve other person outside transporting vehicle, but still a quarter involves other people outside the car.
* Number of persons in transporting vehicle ranging from 1 to 18.
* First harmful events(accidents): first cause of crash and the top 5 harmful events are namely, vehicle in transport, pedestrian, tree, curb and guardrail face.
* Crash related factors: This contains too much missingness. Similar information can also be obtained from vehicle files and person files (vehicle-level related factors, driver-level related factors and person-level related factors in the Person data file). 
* Drunk drivers: There are `r sum(acc$drunk_dr!=0)` drunk driving cases.


__Explorartory analysis__


__Time varying factors__


```{r exploratory analysis of accident files,echo=FALSE}
#exploratory analysis: time-varying
acc_month_sum=acc %>% group_by(year,month) %>%
    summarize(total=n(),fatal=sum(fatals)) %>%
    mutate(ym=as.Date(as.yearmon(paste(year,month,sep="/"),"%Y/%m")))


plot(acc_month_sum$ym,acc_month_sum$total,type="l",col="blue",lwd=2,xlab="Year",ylab="Total number",main="Trend of #accidents/fatalities across year")
lines(acc_month_sum$ym,acc_month_sum$fatal,col="red",lty=2,lwd=2)
legend("bottomleft",legend=c("accident","fatalities"),col=c("blue","red"),lwd=rep(2,2),lty=1:2)


acc_day_sum=acc %>% group_by(day_week) %>%
    summarize(total=n(),fatal=sum(fatals)) 
with(acc_day_sum,plot(day_week,total,type="n",xlab="Day of week",ylab="Total number",main="Trend of #accidents in a week",ylim=c(range(total)[1],range(fatal)[2])))

# for(i in 1:length(unique(acc_day_sum$year))){
#     k=2010+i
#     with(acc_day_sum,lines(day_week[which(year==k)],total[which(year==k)],col=i,lwd=2))
# }

with(acc_day_sum,lines(day_week,total,col="blue",lwd=2))
with(acc_day_sum,lines(day_week,fatal,col="red",lwd=2,lty=2))   
legend("bottomright",legend=c("accident","fatalities"),col=c("blue","red"),lwd=rep(2,2),lty=1:2)
```


From the above plots, we notice that the seasonality of traffic fatality or accidents across years may not be evident, especially for year 2015. But when we have a closer look at day of week, we observe that a strong "weekend effect", with comparably higher accident rate across years.



```{r 2011-2014 acc exploratory analysis md_dc,echo=FALSE}
acc_year_sum=acc %>% group_by(year,geo_id) %>%
    summarize(total=n(),fatal=sum(fatals),lon=mean(longitud),lat=mean(latitude))

#combine acc+population+income(2011-2014) + fatal rate per 1,000 population
acc_year_sum= dplyr::inner_join(acc_year_sum,info_md) %>%
                mutate(fata_rate=(fatal*1000)/population)
acc_year_sum2011=acc_year_sum %>%
                filter(year=="2011") %>%
                select(year,geo_id,population,median_income,fata_rate)
acc_year_sum2012=acc_year_sum %>%
                filter(year=="2012") %>%
                select(year,geo_id,population,median_income,fata_rate)
acc_year_sum2013=acc_year_sum %>%
                filter(year=="2013") %>%
                select(year,geo_id,population,median_income,fata_rate)
acc_year_sum2014=acc_year_sum %>%
                filter(year=="2014") %>%
                select(year,geo_id,population,median_income,fata_rate)

# calculate quantile breaks
acc_year_sum2011$qt <- cut(acc_year_sum2011$fata_rate, 
                    breaks = quantile(acc_year_sum2011$fata_rate, probs = 0:5/5, na.rm = TRUE), 
                    include.lowest = TRUE)


```



__Geographical factors__


To simplify the question, we narrow down to analyze data from Maryland state and District of Columbia area. We calculate county-level fatality rate per 1000 people each year based on population and fatalities. Also, we try to make a comparison between each county's fatality rate and its median household income.


```{r geographical information,warning=FALSE,message=FALSE,echo=FALSE}
#exploratory analysis: Geographical factors
#mapping
# acc2011=subset(acc,year==2011)
# acc2012=subset(acc,year==2012)
# acc2013=subset(acc,year==2013)
# acc2014=subset(acc,year==2014)
# acc2015=subset(acc,year==2015)

map_center=apply(acc[,c('longitud','latitude')],2,median)
map=ggmap(get_map(map_center, zoom=10,maptype = "roadmap",source="google"))

p1=map+geom_point(aes(x=longitud,y=latitude),data = acc1,col="red",alpha=0.4)+ggtitle("Map of accidents in 2011")+xlab("longitude")+ylab("latitude")
p2=map+geom_point(aes(x=longitud,y=latitude),data = acc2,col="red",alpha=0.4)+ggtitle("Map of accidents in 2012")+xlab("longitude")+ylab("latitude")
p3=map+geom_point(aes(x=longitud,y=latitude),data = acc3,col="red",alpha=0.4)+ggtitle("Map of accidents in 2013")+xlab("longitude")+ylab("latitude")
p4=map+geom_point(aes(x=longitud,y=latitude),data = acc4,col="red",alpha=0.4)+ggtitle("Map of accidents in 2014")+xlab("longitude")+ylab("latitude")
p5=map+geom_point(aes(x=longitud,y=latitude),data = acc5,col="red",alpha=0.4)+ggtitle("Map of accidents in 2015")+xlab("longitude")+ylab("latitude")

multiplot(p1, p2, cols=2)

#plots of income + fatality rate
plots(name=c("maryland","district of columbia"),acc_file = acc_year_sum2011,2011)
#plots(name=c("maryland","district of columbia"),acc_file = acc_year_sum2012,2012)
#plots(name=c("maryland","district of columbia"),acc_file = acc_year_sum2013,2013)
#plots(name=c("maryland","district of columbia"),acc_file = acc_year_sum2014,2014)



```


As we could see, there exists negative correlation between regional median household income and regional traffic fatality rate in Maryland state and District of Columbia area in year 2011. 


__Step by step analysis plan__


* Exploratory analysis on state-level (i.e. merging state-level data, plotting heatmaps of state-level fatality rate and median household income)


* Find crash-related factors, not only from accident file, but also from vehicle and person files. 

    + The main issue for finding related factors is that vehicle-level and person-level data files are multiple responses per accident. 

    + Thoughts: conduct principal component analysis on vehicle and person files and extract first 2 principal components from each file as vehicle-related and person-related factors respectively.

* Build prediction models for both state-level and county-level

    + Linear regression/ Poisson regression/ Truncated poisson regression
    
    + Comparison of methods
    
 *  Write reports
    
    
    